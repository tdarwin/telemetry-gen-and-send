services:
  # Generator service - runs once to create telemetry templates
  generator:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: telemetry-generator
    restart: "no" # Run once and exit
    command:
      - telemetry-generator
      - --config
      - /config/examples/generator-config.yaml
      - --output-dir
      - /data/generated
    volumes:
      - telemetry-data:/data
    networks:
      - telemetry-net
    healthcheck:
      disable: true

  # Sender service - reads templates and sends to OTLP endpoint
  # Scale with: docker compose up --scale sender=N
  sender:
    build:
      context: .
      dockerfile: Dockerfile
    restart: unless-stopped
    command:
      - telemetry-sender
      - --config
      - /config/examples/sender-config.yaml
    volumes:
      - telemetry-data:/data:ro # Read-only access to templates
    environment:
      # Required - used in examples/sender-config.yaml
      - HONEYCOMB_API_KEY=${HONEYCOMB_API_KEY:?HONEYCOMB_API_KEY is required}
    depends_on:
      generator:
        condition: service_completed_successfully
    networks:
      - telemetry-net
    deploy:
      replicas: 2
      resources:
        limits:
          cpus: 4
          memory: 5G
        reservations:
          cpus: 2
          memory: 2G

volumes:
  telemetry-data:
    driver: local

networks:
  telemetry-net:
    driver: bridge
